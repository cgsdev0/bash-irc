#!/usr/bin/env bash

cd "${0%/*}"

set noglob

ORM_DB=db.sqlite
VERSION=0.0.1
IRC_SERVER_HOST=127.0.0.1
PORT=${PORT:-6667}

declare -A SUBS
# self explanatory
function query() {
  function _query() {
    local QUERY
    QUERY="$1"
    shift
    printf ".parameter init\n"
    INDEX=1
    for arg in "$@"; do
      : "${arg//\\/\\\\\\\\}"
      : "${_//$'\t'/    }"
      : "${_//\"/\\\"}"
      : "${_//\'/\\\'}"
      : "${_//$'\n'/\\\\n}"
      if [[ "$_" =~ "'" ]]; then
        printf ".parameter set ?%d \"%s\"\n" $INDEX "$_"
      else
        printf ".parameter set ?%d \"'%s'\"\n" $INDEX "$_"
      fi
      ((INDEX++))
    done
    printf "%s\n" "$QUERY";
  }
  sqlite3 -separator $'\t' "$ORM_DB" < <(_query "$@")
}

split() {
   # Usage: split "string" "delimiter"
   IFS=$'\n' read -d "" -ra arr <<< "${1//$2/$'\n'}"
}

function listen() {
  local TOPIC
  TOPIC="$1"
  if [[ -z "$TOPIC" ]]; then
    debug "ATTEMPTED TO LISTEN ON EMPTY TOPIC"
    return
  fi
  local -a arr
  while true; do
    IFS= read -r line < "$TOPIC"
    split "${line//$'\r'}" ' '
    if [[ "${arr[0]}" =~ :(.+) ]]; then
      PREFIX="${BASH_REMATCH[1]}"
      arr=("${arr[@]:1}")
    fi
    COMMAND="${arr[0]}"
    arr=("${arr[@]:1}")

    USER="${PREFIX%%@*}"
    USER="${USER%%!*}"

    case "$COMMAND" in
      PRIVMSG)
        CHANNEL="${arr[0]}"
        [[ "$USER" == "$NICK" ]] && continue
        ;;
      JOIN)
        CHANNEL="${arr[0]:1}"
        if [[ "$USER" == "$NICK" ]]; then
          SUBS["$CHANNEL"]=true
        fi
        ;;
      *)
        continue
        ;;
    esac
    [[ -z "${SUBS[$CHANNEL]}" ]] && debug "FILTERED BY CHANNEL" && continue
    # forward the message
    printf "%s\n" "$line"
  done
}

function subscribe() {
  mkdir -p pubsub/irc
  local tmppipe=$(mktemp -up pubsub/irc)
  mkfifo -m 600 "$tmppipe"
  SUBSCRIPTION="$tmppipe"
  debug "pipe: opened: $tmppipe"
}

function unsubscribe() {
  [[ ! -z "$UNSUBBED" ]] && return
  rm -rf "$HEARTBEAT"
  UNSUBBED=true
  rm -f "$SUBSCRIPTION"
  debug "pipe: closed: $SUBSCRIPTION"
}

function broadcast() {
  [[ ! -d "pubsub/irc" ]] && return
  TEE_ARGS=$(find pubsub/irc -type p)
  [[ -z "$TEE_ARGS" ]] && return
  tee $TEE_ARGS > /dev/null
}

reply() {
  local RESPONSE
  printf -v "RESPONSE" ":%s %s\r\n" "$IRC_SERVER_HOST" "$*"
  RESPONSE="${RESPONSE:0:512}"
  printf "%s" "$RESPONSE"
  debug "outbound: ${RESPONSE//$'\n'/}"
}

debug() {
  printf "%s\n" "$@" 1>&2
}

heartbeat() {
  while true; do
    if [[ ! -f "$HEARTBEAT" ]]; then
      debug "heartbeat: already closed"
      exit 1
    fi
    if [[ "$(<$HEARTBEAT)" -lt $PING ]]; then
      debug "heartbeat: ping lt $PING, disconnecting"
      exit 1
    fi
    reply PING ":$PING"
    ((PING++))
    sleep 60
  done
}

if [[ -z "$IRC_CONN_HANDLER" ]]; then

  rm -rf pubsub
  mkdir pubsub


  query 'CREATE TABLE IF NOT EXISTS channels
    (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      name varchar(201)
    );'

  echo -n "main: Starting server on port "

  export IRC_CONN_HANDLER=true
  export IRC_SERVER_CREATED="$(date)"
  tcpserver -v -1 -o -l 0 -H -D -R -c 1000 0 $PORT $0
else
  PING=0
  PONG=0
  # echo "connection opened with $TCPREMOTEIP" 1>&2
  subscribe
  mkdir -p pubsub/heartbeat
  HEARTBEAT="$(mktemp -p pubsub/heartbeat)"
  debug "heartbeat: opened $HEARTBEAT"
  echo 0 > "$HEARTBEAT"
  heartbeat &
  trap unsubscribe EXIT
  while IFS= read -r line; do
    split "${line//$'\r'}" ' '
    if [[ "${arr[0]}" =~ :(.+) ]]; then
      PREFIX="${BASH_REMATCH[1]}"
      arr=("${arr[@]:1}")
    fi
    COMMAND="${arr[0]}"
    debug "inbound: $COMMAND"
    arr=("${arr[@]:1}")
    case "${COMMAND^^}" in
      # CAP)
      #   CAP="${arr[0]}"
      #   reply CAP "* NAK :"
      #   ;;
      NICK)
        NICK="${arr[0]}"
        ;;
      USER)
        USER="${arr[0]}"
        MODE="${arr[1]}"
        REALNAME="${arr[3]}"
        reply 001 $NICK ":Welcome, $NICK!$USER@$IRC_SERVER_HOST"
        reply 002 $NICK ":Your host is $IRC_SERVER_HOST, running version $VERSION"
        reply 003 $NICK ":This server was created $IRC_SERVER_CREATED"
        reply 004 $NICK "$IRC_SERVER_HOST bash-$VERSION"
        reply 376 $NICK ":End of the /MOTD command."
        listen "$SUBSCRIPTION" &
        ;;
      PRIVMSG)
        TARGET="${arr[0]}"
        arr=("${arr[@]:1}")
        printf "%s\r\n" ":$NICK PRIVMSG $TARGET ${arr[*]}" | broadcast
        ;;
      JOIN)
        if [[ "${arr[@]}" == "0" ]]; then
          debug "joins: $NICK did join 0"
        else
          CHANNELS="${arr[0]}"
          KEYS="${arr[1]}"
          split "$CHANNELS" ','
          CHANNELS=("${arr[@]}")
          split "$KEYS" ','
          KEYS=("${arr[@]}")
          for CHANNEL in ${CHANNELS[@]}; do
            if [[ "$CHANNEL" != "#test" ]]; then
              continue
            fi
            debug "joins: $NICK joined $CHANNEL"
            SUBS["$CHANNEL"]=true
            printf "%s\r\n" ":$NICK!$USER@$IRC_SERVER_HOST JOIN :$CHANNEL" | broadcast
            reply 366 $NICK $CHANNEL :
          done
        fi
        ;;
      PING)
        reply PONG "$NICK" "${arr[0]}"
        ;;
      PONG)
        ((PONG++))
        echo "$PONG" > "$HEARTBEAT"
        ;;
      *)
        :
        ;;
    esac
  done
  unsubscribe
fi
